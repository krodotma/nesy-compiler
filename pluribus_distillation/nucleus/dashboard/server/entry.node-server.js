import{createReadStream as xt,statSync as Ft}from"node:fs";import{createServer as Bt}from"node:http";import{join as k,basename as Gt,extname as At,resolve as $}from"node:path";import{fileURLToPath as et}from"node:url";import{s as Qt,r as Jt}from"./q-BcD-hcJK.js";import{getNotFound as Kt}from"./@qwik-city-not-found-paths.js";import{isStaticPath as ot}from"./@qwik-city-static-paths.js";import{Http2ServerRequest as Xt}from"node:http2";import{TextEncoderStream as Yt,TextDecoderStream as Vt,WritableStream as Zt,ReadableStream as qt}from"node:stream/web";import{fetch as te,Headers as ee,Request as ne,Response as re,FormData as ae}from"undici";import se from"crypto";import{v as ie,h as oe,j as ce}from"./q-CjCWtRhd.js";import le from"./@qwik-city-plan.js";function Q(t,e){let n="Server Error";return e!=null&&(typeof e.message=="string"?n=e.message:n=String(e)),"<html>"+fe(t,n)+"</html>"}function fe(t,e){typeof t!="number"&&(t=500),typeof e=="string"?e=de(e):e="";const n=typeof e=="string"?"600px":"300px",r=t>=500?he:pe;return`
<head>
  <meta charset="utf-8">
  <meta http-equiv="Status" content="${t}">
  <title>${t} ${e}</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { color: ${r}; background-color: #fafafa; padding: 30px; font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, Roboto, sans-serif; }
    p { max-width: ${n}; margin: 60px auto 30px auto; background: white; border-radius: 4px; box-shadow: 0px 0px 50px -20px ${r}; overflow: hidden; }
    strong { display: inline-block; padding: 15px; background: ${r}; color: white; }
    span { display: inline-block; padding: 15px; }
  </style>
</head>
<body><p><strong>${t}</strong> <span>${e}</span></p></body>
`}var ue=/[&<>]/g,de=t=>t.replace(ue,e=>{switch(e){case"&":return"&amp;";case"<":return"&lt;";case">":return"&gt;";default:return""}}),pe="#006ce9",he="#713fc2",me={lax:"Lax",Lax:"Lax",None:"None",none:"None",strict:"Strict",Strict:"Strict"},ge={seconds:1,minutes:1*60,hours:1*60*60,days:1*60*60*24,weeks:1*60*60*24*7},ct=(t,e,n)=>{const r=[`${t}=${e}`];typeof n.domain=="string"&&r.push(`Domain=${n.domain}`),typeof n.maxAge=="number"?r.push(`Max-Age=${n.maxAge}`):Array.isArray(n.maxAge)?r.push(`Max-Age=${n.maxAge[0]*ge[n.maxAge[1]]}`):typeof n.expires=="number"||typeof n.expires=="string"?r.push(`Expires=${n.expires}`):n.expires instanceof Date&&r.push(`Expires=${n.expires.toUTCString()}`),n.httpOnly&&r.push("HttpOnly"),typeof n.path=="string"&&r.push(`Path=${n.path}`);const s=we(n.sameSite);return s&&r.push(`SameSite=${s}`),n.secure&&r.push("Secure"),r.join("; ")};function lt(t){try{return decodeURIComponent(t)}catch{return t}}var ye=t=>{const e={};if(typeof t=="string"&&t!==""){const n=t.split(";");for(const r of n){const s=r.indexOf("=");s!==-1&&(e[lt(r.slice(0,s).trim())]=lt(r.slice(s+1).trim()))}}return e};function we(t){if(t===!0)return"Strict";if(t===!1)return"None";if(t)return me[t]}var C=Symbol("request-cookies"),H=Symbol("response-cookies"),R=Symbol("live-cookies"),be=class{[C];[H]={};[R]={};appendCounter=0;constructor(t){this[C]=ye(t),this[R]={...this[C]}}get(t,e=!0){const n=this[e?R:C][t];return n?{value:n,json(){return JSON.parse(n)},number(){return Number(n)}}:null}getAll(t=!0){return Object.keys(this[t?R:C]).reduce((e,n)=>(e[n]=this.get(n),e),{})}has(t,e=!0){return!!this[e?R:C][t]}set(t,e,n={}){this[R][t]=typeof e=="string"?e:JSON.stringify(e);const r=typeof e=="string"?e:encodeURIComponent(JSON.stringify(e));this[H][t]=ct(t,r,n)}append(t,e,n={}){this[R][t]=typeof e=="string"?e:JSON.stringify(e);const r=typeof e=="string"?e:encodeURIComponent(JSON.stringify(e));this[H][++this.appendCounter]=ct(t,r,n)}delete(t,e){this.set(t,"deleted",{...e,maxAge:0}),this[R][t]=null}headers(){return Object.values(this[H])}},I=class extends Error{constructor(t,e){super(typeof e=="string"?e:void 0),this.status=t,this.data=e}},N=class{},nt=class extends N{},Ct=class extends N{constructor(t){super(),this.pathname=t}},ft=new WeakMap,ut="qaction",Se="qfunc",dt="qdata";function ve(t,e){const n=mt(t),r=pt(t),s=mt(e),a=pt(e);return Pt(t,n,r,e,s,a)}function Pt(t,e,n,r,s,a){if(r.startsWith("/build/"))return null;let o=null;for(;e<n;){const i=t.charCodeAt(e++),c=r.charCodeAt(s++);if(i===91){const l=Dt(t,e),u=e+(l?3:0),d=J(t,u,n,93),f=t.substring(u,d),m=J(t,d+1,n,47),p=t.substring(d+1,m);e=d+1;const w=s-1;if(l){const x=Te(f,p,r,w,a,t,e+p.length+1,n);if(x)return Object.assign(o||(o={}),x)}const y=J(r,w,a,47,p);if(y==-1)return null;const S=r.substring(w,y);if(!l&&!p&&!S)return null;s=y,(o||(o={}))[f]=decodeURIComponent(S)}else if(i!==c&&!(isNaN(c)&&_e(t,e)))return null}return ht(t,e)&&ht(r,s)?o||{}:null}function _e(t,e){return t.charCodeAt(e)===91&&Dt(t,e+1)}function pt(t){const e=t.length;return e>1&&t.charCodeAt(e-1)===47?e-1:e}function ht(t,e){const n=t.length;return e>=n||e==n-1&&t.charCodeAt(e)===47}function mt(t){return t.charCodeAt(0)===47?1:0}function Dt(t,e){return t.charCodeAt(e)===46&&t.charCodeAt(e+1)===46&&t.charCodeAt(e+2)===46}function J(t,e,n,r,s=""){for(;e<n&&t.charCodeAt(e)!==r;)e++;const a=s.length;for(let o=0;o<a;o++)if(t.charCodeAt(e-a+o)!==s.charCodeAt(o))return-1;return e-a}function Te(t,e,n,r,s,a,o,i){n.charCodeAt(r)===47&&r++;let c=s;const l=e+"/";for(;c>=r;){const u=Pt(a,o,i,n,c,s);if(u){let f=n.substring(r,Math.min(c,s));return f.endsWith(l)&&(f=f.substring(0,f.length-l.length)),u[t]=decodeURIComponent(f),u}const d=Re(n,r,l,c,r-1)+l.length;if(c===d)break;c=d}return null}function Re(t,e,n,r,s){let a=t.lastIndexOf(n,r);return a==r-n.length&&(a=t.lastIndexOf(n,r-n.length-1)),a>e?a:s}var xe=async(t,e,n,r,s)=>{if(!Array.isArray(t))return null;for(const a of t){const o=a[0],i=ve(o,r);if(!i)continue;const c=a[1],l=a[3],u=new Array(c.length),d=[];c.forEach((m,p)=>{gt(m,d,w=>u[p]=w,n)});let f;if(!s){const m=Ae(e,r);gt(m,d,p=>f=p?.default,n)}return d.length>0&&await Promise.all(d),[o,i,u,f,l]}return null},gt=(t,e,n,r)=>{if(typeof t=="function"){const s=ft.get(t);if(s)n(s);else{const a=t();typeof a.then=="function"?e.push(a.then(o=>{r!==!1&&ft.set(t,o),n(o)})):a&&n(a)}}},Ae=(t,e)=>{if(t){e=e.endsWith("/")?e:e+"/";const n=t.find(r=>r[0]===e||e.startsWith(r[0]));if(n)return n[1]}},Ce=t=>t&&typeof t.then=="function";function Pe(t){const e=[];return t==="day"?t=60*60*24:t==="week"?t=60*60*24*7:t==="month"?t=60*60*24*30:t==="year"?t=60*60*24*365:t==="private"?t={private:!0,noCache:!0}:t==="immutable"?t={public:!0,immutable:!0,maxAge:60*60*24*365}:t==="no-cache"&&(t={noCache:!0}),typeof t=="number"&&(t={maxAge:t,sMaxAge:t}),t.immutable&&e.push("immutable"),t.maxAge&&e.push(`max-age=${t.maxAge}`),t.sMaxAge&&e.push(`s-maxage=${t.sMaxAge}`),t.noStore&&e.push("no-store"),t.noCache&&e.push("no-cache"),t.private&&e.push("private"),t.public&&e.push("public"),t.staleWhileRevalidate&&e.push(`stale-while-revalidate=${t.staleWhileRevalidate}`),t.staleIfError&&e.push(`stale-if-error=${t.staleIfError}`),e.join(", ")}var U;import("node:async_hooks").then(t=>{const e=t.AsyncLocalStorage;U=new e,globalThis.qcAsyncRequestStore=U}).catch(t=>{console.warn("AsyncLocalStorage not available, continuing without it. This might impact concurrent server calls.",t)});function De(t,e,n,r,s=!0,a="/",o){let i;const c=new Promise(u=>i=u),l=Oe(t,e,n,s,a,o,i);return{response:c,requestEv:l,completion:U?U.run(l,yt,l,r,i):yt(l,r,i)}}async function yt(t,e,n){try{(o=>new URL(o.pathname+o.search,o))(t.originalUrl)}catch{const o="Resource Not Found";t.status(404);const i=Q(404,o);return t.html(404,i),new I(404,o)}let r=1;async function s(){try{await t.next()}catch(a){if(a instanceof nt)await t.getWritableStream().close();else if(a instanceof Ct){if(r>50)throw new Error("Infinite rewrite loop");r+=1;const o=new URL(t.url);o.pathname=a.pathname;const{loadedRoute:i,requestHandlers:c}=await e(o);return t.resetRoute(i,c,o),await s()}else if(a instanceof I){if(!t.headersSent){const o=a.status,i=t.request.headers.get("Accept");if(i&&!i.includes("text/html")){const c=t[M];t.headers.set("Content-Type","application/qwik-json"),t.send(o,await c._serializeData(a.data,!0))}else{const c=Q(a.status,a.data);t.html(o,c)}}}else if(!(a instanceof N)){if(F(t)!=="dev")try{t.headersSent||(t.headers.set("content-type","text/html; charset=utf-8"),t.cacheControl({noCache:!0}),t.status(500));const o=t.getWritableStream();if(!o.locked){const i=o.getWriter();await i.write(B.encode(Q(500,"Internal Server Error"))),await i.close()}}catch{console.error("Unable to render error page")}return a}}}try{return await s()}finally{t.isDirty()||n(null)}}function tt(t,e){const n=t.endsWith(D);if(n){const r=t.length-D.length+(e?1:0);t=t.slice(0,r),t===""&&(t="/")}return{pathname:t,isInternal:n}}var rt="@isQData",D="/q-data.json",Mt=Symbol("RequestEvLoaders"),Ot=Symbol("RequestEvMode"),kt=Symbol("RequestEvRoute"),M=Symbol("RequestEvQwikSerializer"),Ht=Symbol("RequestEvTrailingSlash"),Lt="@routeName",z="@actionId",$t="@actionFormData",Me="@nonce",It="@rewrite";function Oe(t,e,n,r,s,a,o){const{request:i,platform:c,env:l}=t,u=new Map,d=new be(i.headers.get("cookie")),f=new Headers,m=new URL(i.url),{pathname:p,isInternal:w}=tt(m.pathname,r);w&&(m.pathname=p,u.set(rt,!0));let y=-1,S=null,x,st=t.locale,T=200;const jt=async()=>{for(y++;y<n.length;){const h=n[y],g=globalThis.qcAsyncRequestStore,b=g?.run?g.run(v,h,v):h(v);Ce(b)&&await b,y++}},Nt=(h,g,b=m)=>{e=h,n=g,m.pathname=b.pathname,m.search=b.search,y=-1},A=()=>{if(S!==null)throw new Error("Response already sent")},O=(h,g)=>{if(A(),typeof h=="number"){T=h;const _=v.getWritableStream().getWriter();_.write(typeof g=="string"?B.encode(g):g),_.close()}else if(T=h.status,h.headers.forEach((b,_)=>{_.toLowerCase()!=="set-cookie"&&f.append(_,b)}),h.headers.getSetCookie().forEach(b=>{const _=b.indexOf("=");if(_===-1)return;const zt=b.slice(0,_).trim(),Et=b.slice(_+1).trim();d.set(zt,Et)}),h.body){const b=v.getWritableStream();h.body.pipeTo(b)}else v.getWritableStream().getWriter().close();return it()},it=()=>(y=K,new N),G={},v={[Mt]:G,[Ot]:t.mode,[Ht]:r,get[kt](){return e},[M]:a,cookie:d,headers:f,env:l,method:i.method,signal:i.signal,originalUrl:new URL(m),get params(){return e?.[1]??{}},get pathname(){return m.pathname},platform:c,get query(){return m.searchParams},request:i,url:m,basePathname:s,sharedMap:u,get headersSent(){return S!==null},get exited(){return y>=K},get clientConn(){return t.getClientConn()},next:jt,resetRoute:Nt,exit:it,cacheControl:(h,g="Cache-Control")=>{A(),f.set(g,Pe(h))},resolveValue:async h=>{const g=h.__id;if(h.__brand==="server_loader"&&!(g in G))throw new Error("You can not get the returned data of a loader that has not been executed for this request.");return G[g]},status:h=>typeof h=="number"?(A(),T=h,h):T,locale:h=>(typeof h=="string"&&(st=h),st||""),error:(h,g)=>(T=h,f.delete("Cache-Control"),new I(h,g)),redirect:(h,g)=>{if(A(),T=h,g){if(/([^:])\/{2,}/.test(g)){const b=g.replace(/([^:])\/{2,}/g,"$1/");console.warn(`Redirect URL ${g} is invalid, fixing to ${b}`),g=b}f.set("Location",g)}return f.delete("Cache-Control"),h>301&&f.set("Cache-Control","no-store"),y=K,new nt},rewrite:h=>{if(A(),h.startsWith("http"))throw new Error("Rewrite does not support absolute urls");return u.set(It,!0),new Ct(h.replace(/\/+/g,"/"))},defer:h=>typeof h=="function"?h:()=>h,fail:(h,g)=>(A(),T=h,f.delete("Cache-Control"),{failed:!0,...g}),text:(h,g)=>(f.set("Content-Type","text/plain; charset=utf-8"),O(h,g)),html:(h,g)=>(f.set("Content-Type","text/html; charset=utf-8"),O(h,g)),parseBody:async()=>x!==void 0?x:x=He(v,u,a),json:(h,g)=>(f.set("Content-Type","application/json; charset=utf-8"),O(h,JSON.stringify(g))),send:O,isDirty:()=>S!==null,getWritableStream:()=>{if(S===null){if(t.mode==="dev"){const h=u.get("@serverTiming");h&&f.set("Server-Timing",h.map(g=>`${g[0]};dur=${g[1]}`).join(","))}S=t.getWritableStream(T,f,d,o,v)}return S}};return Object.freeze(v)}function E(t){return t[Mt]}function at(t){return t[Ht]}function ke(t){return t[kt]}function F(t){return t[Ot]}var K=Number.MAX_SAFE_INTEGER,He=async({request:t,method:e,query:n},r,s)=>{var a;const o=((a=t.headers.get("content-type"))==null?void 0:a.split(/[;,]/,1)[0].trim())??"";if(o==="application/x-www-form-urlencoded"||o==="multipart/form-data"){const i=await t.formData();return r.set($t,i),Le(i)}else{if(o==="application/json")return await t.json();if(o==="application/qwik-json"){if(e==="GET"&&n.has(dt)){const i=n.get(dt);if(i)try{return s._deserializeData(decodeURIComponent(i))}catch{}}return s._deserializeData(await t.text())}}},Le=t=>[...t.entries()].reduce((n,[r,s])=>(r.split(".").reduce((a,o,i,c)=>{if(o.endsWith("[]")){const l=o.slice(0,-2);return a[l]=a[l]||[],a[l]=[...a[l],s]}return i<c.length-1?a[o]=a[o]||(Number.isNaN(+c[i+1])?{}:[]):a[o]=s},n),n),{});function $e(t){const{params:e,request:n,status:r,locale:s,originalUrl:a}=t,o={};n.headers.forEach((w,y)=>o[y]=w);const i=t.sharedMap.get(z),c=t.sharedMap.get($t),l=t.sharedMap.get(Lt),u=t.sharedMap.get(Me),d=t.request.headers,f=new URL(a.pathname+a.search,a),m=d.get("X-Forwarded-Host"),p=d.get("X-Forwarded-Proto");return m&&(f.port="",f.host=m),p&&(f.protocol=p),{url:f.href,requestHeaders:o,locale:s(),nonce:u,containerAttributes:{"q:route":l},qwikcity:{routeName:l,ev:t,params:{...e},loadedRoute:ke(t),response:{status:r(),loaders:E(t),action:i,formData:c}}}}var Ie=(t,e,n,r,s,a)=>{const o=[],i=[],c=[],l=!!(e&&Ee(e[2]));if(a&&c.push(Qe),t&&wt(o,i,c,t,l,n),e){const u=e[0];r&&(n==="POST"||n==="PUT"||n==="PATCH"||n==="DELETE")&&(r==="lax-proto"?c.unshift(Fe):c.unshift(Be)),l&&((n==="POST"||n==="GET")&&c.push(je),c.push(Ne),a&&c.push(Je));const d=e[2];wt(o,i,c,d,l,n),l&&(c.push(f=>{f.sharedMap.set(Lt,u)}),c.push(Ue(i,o)),c.push(s))}return c},wt=(t,e,n,r,s,a)=>{for(const o of r){typeof o.onRequest=="function"?n.push(o.onRequest):Array.isArray(o.onRequest)&&n.push(...o.onRequest);let i;switch(a){case"GET":{i=o.onGet;break}case"POST":{i=o.onPost;break}case"PUT":{i=o.onPut;break}case"PATCH":{i=o.onPatch;break}case"DELETE":{i=o.onDelete;break}case"OPTIONS":{i=o.onOptions;break}case"HEAD":{i=o.onHead;break}}if(typeof i=="function"?n.push(i):Array.isArray(i)&&n.push(...i),s)for(const c of Object.values(o))typeof c=="function"&&(c.__brand==="server_loader"?t.push(c):c.__brand==="server_action"&&e.push(c))}};function Ue(t,e){return async n=>{if(n.headersSent){n.exit();return}const{method:r}=n,s=E(n),a=F(n)==="dev",o=n[M];if(a&&r==="GET"&&n.query.has(ut)&&console.warn(`Seems like you are submitting a Qwik Action via GET request. Qwik Actions should be submitted via POST request.
Make sure your <form> has method="POST" attribute, like this: <form method="POST">`),r==="POST"){const i=n.query.get(ut);if(i){const c=globalThis._qwikActionsMap,l=t.find(u=>u.__id===i)??c?.get(i);if(l){n.sharedMap.set(z,i);const u=await n.parseBody();if(!u||typeof u!="object")throw new Error(`Expected request data for the action id ${i} to be an object`);const d=await bt(n,l.__validators,u,a);if(!d.success)s[i]=n.fail(d.status??500,d.error);else{const f=a?await j(n,l.__qrl.getSymbol().split("_",1)[0],()=>l.__qrl.call(n,d.data,n)):await l.__qrl.call(n,d.data,n);a&&W(o,f,l.__qrl),s[i]=f}}}}if(e.length>0){const i=e.map(c=>{const l=c.__id;return s[l]=bt(n,c.__validators,void 0,a).then(u=>u.success?a?j(n,c.__qrl.getSymbol().split("_",1)[0],()=>c.__qrl.call(n,n)):c.__qrl.call(n,n):n.fail(u.status??500,u.error)).then(u=>(typeof u=="function"?s[l]=u():(a&&W(o,u,c.__qrl),s[l]=u),u)),s[l]});await Promise.all(i)}}}async function bt(t,e,n,r){let s={success:!0,data:n};if(e)for(const a of e)if(r?s=await j(t,"validator$",()=>a.validate(t,n)):s=await a.validate(t,n),s.success)n=s.data;else return s;return s}function We(t){return t?typeof t=="object"&&Symbol.asyncIterator in t:!1}async function je(t){const e=t.query.get(Se);if(e&&t.request.headers.get("X-QRL")===e&&t.request.headers.get("Content-Type")==="application/qwik-json"){t.exit();const n=F(t)==="dev",r=t[M],s=await t.parseBody();if(Array.isArray(s)){const[a,...o]=s;if(ze(a)&&a.getHash()===e){let i;try{n?i=await j(t,`server_${a.getSymbol()}`,()=>a.apply(t,o)):i=await a.apply(t,o)}catch(c){throw c instanceof I?t.error(c.status,c.data):t.error(500,"Invalid request")}if(We(i)){t.headers.set("Content-Type","text/qwik-json-stream");const l=t.getWritableStream().getWriter();for await(const u of i){n&&W(r,u,a);const d=await r._serializeData(u,!0);if(t.signal.aborted)break;await l.write(B.encode(`${d}
`))}l.close()}else{W(r,i,a),t.headers.set("Content-Type","application/qwik-json");const c=await r._serializeData(i,!0);t.send(200,c)}return}}throw t.error(500,"Invalid request")}}function Ne(t){const e=at(t),{basePathname:n,originalUrl:r,sharedMap:s}=t,{pathname:a,search:o}=r;if(!s.has(rt)&&a!==n&&!a.endsWith(".html")){if(e){if(!a.endsWith("/"))throw t.redirect(301,a+"/"+o)}else if(a.endsWith("/"))throw t.redirect(301,a.slice(0,a.length-1)+o)}}function W(t,e,n){try{t._verifySerializable(e,void 0)}catch(r){throw r instanceof Error&&n.dev&&(r.loc=n.dev),r}}var ze=t=>typeof t=="function"&&typeof t.getSymbol=="function";function Ee(t){const e=t[t.length-1];return e&&typeof e.default=="function"}function Ut(t,e){t=new URL(t),t.pathname.endsWith(D)&&(t.pathname=t.pathname.slice(0,-D.length)),e?t.pathname.endsWith("/")||(t.pathname+="/"):t.pathname.endsWith("/")&&(t.pathname=t.pathname.slice(0,-1));const n=t.search.slice(1).replaceAll(/&?q(action|data|func)=[^&]+/g,"");return`${t.pathname}${n?`?${n}`:""}${t.hash}`}var B=new TextEncoder;function Fe(t){Wt(t,"lax-proto")}function Be(t){Wt(t)}function Wt(t,e){if(Xe(t.request.headers,"application/x-www-form-urlencoded","multipart/form-data","text/plain")){const r=t.request.headers.get("origin"),s=t.url.origin;let a=r!==s;if(a&&e&&r?.replace(/^http(s)?/g,"")===s.replace(/^http(s)?/g,"")&&(a=!1),a)throw t.error(403,`CSRF check failed. Cross-site ${t.method} form submissions are forbidden.
The request origin "${r}" does not match the server origin "${s}".`)}}function Ge(t){return async e=>{if(e.headersSent||e.sharedMap.has(rt))return;e.request.headers.forEach((d,f)=>d);const r=e.headers;r.has("Content-Type")||r.set("Content-Type","text/html; charset=utf-8");const s=at(e),{readable:a,writable:o}=new TextEncoderStream,i=e.getWritableStream(),c=a.pipeTo(i,{preventClose:!0}),l=o.getWriter(),u=e.status();try{const d=F(e)==="static",f=$e(e),m=await t({base:e.basePathname+"build/",stream:l,serverData:f,containerAttributes:{"q:render":d?"static":"",...f.containerAttributes}}),p={loaders:E(e),action:e.sharedMap.get(z),status:u!==200?u:200,href:Ut(e.url,s)};typeof m.html=="string"&&await l.write(m.html),e.sharedMap.set("qData",p)}finally{await l.ready,await l.close(),await c}await i.close()}}async function Qe(t){try{await t.next()}catch(s){if(!(s instanceof nt))throw s}if(t.headersSent)return;const e=t.status(),n=t.headers.get("Location");if(e>=301&&e<=308&&n){const s=Ke(n);if(s){t.headers.set("Location",s),t.getWritableStream().close();return}else t.status(200),t.headers.delete("Location")}}async function Je(t){if(await t.next(),t.headersSent||t.exited)return;const e=t.status(),n=t.headers.get("Location"),r=at(t);t.request.headers.forEach((c,l)=>c),t.headers.set("Content-Type","application/json; charset=utf-8");const s={loaders:E(t),action:t.sharedMap.get(z),status:e!==200?e:200,href:Ut(t.url,r),redirect:n??void 0,isRewrite:t.sharedMap.get(It)},a=t.getWritableStream().getWriter(),i=await t[M]._serializeData(s,!0);a.write(B.encode(i)),t.sharedMap.set("qData",s),a.close()}function Ke(t){if(t.startsWith("/")){if(!t.includes(D)){const e=new URL(t,"http://localhost");return(e.pathname.endsWith("/")?e.pathname.slice(0,-1):e.pathname)+D+e.search}return t}else return}function St(){return typeof performance<"u"?performance.now():0}async function j(t,e,n){const r=St();try{return await n()}finally{const s=St()-r;let a=t.sharedMap.get("@serverTiming");a||t.sharedMap.set("@serverTiming",a=[]),a.push([e,s])}}function Xe(t,...e){var n;const r=((n=t.get("content-type"))==null?void 0:n.split(/;/,1)[0].trim())??"";return e.includes(r)}async function Ye(t,e,n){const{render:r,qwikCityPlan:s,checkOrigin:a}=e,{pathname:o,isInternal:i}=tt(t.url.pathname,s.trailingSlash),c=await vt(s,o,t.request.method,a??!0,r,i);if(c){const[l,u]=c;return De(t,l,u,async f=>{const{pathname:m}=tt(f.pathname,s.trailingSlash),p=await vt(s,m,t.request.method,a??!0,r,i);if(p){const[w,y]=p;return{loadedRoute:w,requestHandlers:y}}else return{loadedRoute:null,requestHandlers:[]}},s.trailingSlash,s.basePathname,n)}return null}async function vt(t,e,n,r,s,a){const{routes:o,serverPlugins:i,menus:c,cacheModules:l}=t,u=await xe(o,c,l,e,a),d=Ie(i,u,n,r,Ge(s),a);return d.length>0?[u,d]:null}function X(t,e){var n;return((n=e?.getOrigin)==null?void 0:n.call(e,t))??e?.origin??process.env.ORIGIN??Ve(t)}function Ve(t){const{PROTOCOL_HEADER:e,HOST_HEADER:n}=process.env,r=t.headers,s=e&&r[e]||(t.socket.encrypted||t.connection.encrypted?"https":"http"),a=n??(t instanceof Xt?":authority":"host"),o=r[a];return`${s}://${o}`}function Y(t,e){return qe(t.originalUrl||t.url||"/",e)}function Ze(t=""){return["The stream has been destroyed","write after end"].some(n=>t.includes(n))}var _t=/^:(method|scheme|authority|path)$/i;function qe(t,e){const n=/\/\/|\\\\/g;return new URL(t.replace(n,"/"),e)}async function tn(t,e,n,r,s){const a=new Headers,o=e.headers;try{for(const[f,m]of Object.entries(o))if(!_t.test(f)){if(typeof m=="string")a.set(f,m);else if(Array.isArray(m))for(const p of m)a.append(f,p)}}catch(f){console.error(f)}const i=async function*(){for await(const f of e)yield f},c=e.method==="HEAD"||e.method==="GET"?void 0:i(),l=new AbortController,u={method:e.method,headers:a,body:c,signal:l.signal,duplex:"half"};return n.on("close",()=>{l.abort()}),{mode:r,url:t,request:new Request(t.href,u),env:{get(f){return process.env[f]}},getWritableStream:(f,m,p)=>{n.statusCode=f;try{for(const[y,S]of m)_t.test(y)||n.setHeader(y,S);const w=p.headers();w.length>0&&n.setHeader("Set-Cookie",w)}catch(w){console.error(w)}return new WritableStream({write(w){n.closed||n.destroyed||n.write(w,y=>{y&&!Ze(y.message)&&console.error(y)})},close(){n.end()}})},getClientConn:()=>s?s(e):{ip:e.socket.remoteAddress},platform:{ssr:!0,incomingMessage:e,node:process.versions.node},locale:void 0}}var en={"3gp":"video/3gpp","3gpp":"video/3gpp",asf:"video/x-ms-asf",asx:"video/x-ms-asf",avi:"video/x-msvideo",avif:"image/avif",bmp:"image/x-ms-bmp",css:"text/css",flv:"video/x-flv",gif:"image/gif",htm:"text/html",html:"text/html",ico:"image/x-icon",jng:"image/x-jng",jpeg:"image/jpeg",jpg:"image/jpeg",js:"application/javascript",json:"application/json",kar:"audio/midi",m4a:"audio/x-m4a",m4v:"video/x-m4v",mid:"audio/midi",midi:"audio/midi",mng:"video/x-mng",mov:"video/quicktime",mp3:"audio/mpeg",mp4:"video/mp4",mpeg:"video/mpeg",mpg:"video/mpeg",ogg:"audio/ogg",pdf:"application/pdf",png:"image/png",rar:"application/x-rar-compressed",shtml:"text/html",svg:"image/svg+xml",svgz:"image/svg+xml",tif:"image/tiff",tiff:"image/tiff",ts:"video/mp2t",txt:"text/plain",wbmp:"image/vnd.wap.wbmp",webm:"video/webm",webp:"image/webp",wmv:"video/x-ms-wmv",woff:"font/woff",woff2:"font/woff2",xml:"text/xml",zip:"application/zip"};function nn(){typeof global<"u"&&typeof globalThis.fetch!="function"&&typeof process<"u"&&process.versions.node&&(globalThis.fetch=te,globalThis.Headers=ee,globalThis.Request=ne,globalThis.Response=re,globalThis.FormData=ae),typeof globalThis.TextEncoderStream>"u"&&(globalThis.TextEncoderStream=Yt,globalThis.TextDecoderStream=Vt),typeof globalThis.WritableStream>"u"&&(globalThis.WritableStream=Zt,globalThis.ReadableStream=qt),typeof globalThis.crypto>"u"&&(globalThis.crypto=se.webcrypto)}function rn(t){var e;nn();const n={_deserializeData:ce,_serializeData:oe,_verifySerializable:ie};t.manifest&&Qt(t.manifest);const r=((e=t.static)==null?void 0:e.root)??k(et(import.meta.url),"..","..","dist");return{router:async(i,c,l)=>{try{const u=X(i,t),d=await tn(Y(i,u),i,c,"server",t.getClientConn),f=await Ye(d,t,n);if(f){const m=await f.completion;if(m)throw m;if(f.requestEv.headersSent)return}l()}catch(u){console.error(u),l(u)}},notFound:async(i,c,l)=>{try{if(!c.headersSent){const u=X(i,t),d=Y(i,u),f=ot(i.method||"GET",d)?"Not Found":Kt(d.pathname);c.writeHead(404,{"Content-Type":"text/html; charset=utf-8","X-Not-Found":d.pathname}),c.end(f)}}catch(u){console.error(u),l(u)}},staticFile:async(i,c,l)=>{var u;try{const d=X(i,t),f=Y(i,d);if(ot(i.method||"GET",f)){const m=f.pathname;let p;Gt(m).includes(".")?p=k(r,m):t.qwikCityPlan.trailingSlash?p=k(r,m+"index.html"):p=k(r,m,"index.html");const w=At(p).replace(/^\./,""),y=xt(p);y.on("error",l);const S=en[w];S&&c.setHeader("Content-Type",S),(u=t.static)!=null&&u.cacheControl&&c.setHeader("Cache-Control",t.static.cacheControl),y.pipe(c);return}return l()}catch(d){console.error(d),l(d)}}}}const Tt=rn({render:Jt,qwikCityPlan:{...le,trailingSlash:!1}}),Rt=$(et(import.meta.url),"..","..","dist"),an={},sn={css:"text/css",js:"application/javascript",map:"application/json",json:"application/json",svg:"image/svg+xml",ico:"image/x-icon",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",webp:"image/webp",woff:"font/woff",woff2:"font/woff2",txt:"text/plain"},P=process.env.BUS_BRIDGE_API_URL||"http://127.0.0.1:9201",on=process.env.TOOLS_API_URL||"http://127.0.0.1:9300",cn=1500,ln=["self.addEventListener('install', (event) => {","  self.skipWaiting();","});","self.addEventListener('activate', (event) => {","  event.waitUntil(","    self.registration.unregister().then(() => self.clients.matchAll()).then((clients) => {","      clients.forEach((client) => client.navigate(client.url));","    })","  );","});"].join(`
`),fn=(t,e)=>{const n=(t.method||"GET").toUpperCase();if(n!=="GET"&&n!=="HEAD")return!1;let s=new URL(t.url||"/","http://static").pathname;if(s==="/vnc"||s.startsWith("/vnc/"))return e.statusCode=302,e.setHeader("Location",`https://kroma.live${s}`),e.end(),!0;if(s==="/service-worker.js")return e.setHeader("Content-Type","application/javascript"),e.setHeader("Cache-Control","no-store"),e.statusCode=200,e.end(ln),!0;const a=an[s];a&&(s=`/${a}`);const o=s.replace(/^\/+/,"");if(!o)return!1;const i=$(Rt,o);if(!i.startsWith(`${Rt}/`))return!1;try{if(!Ft(i).isFile())return!1}catch{return!1}const c=At(i).slice(1).toLowerCase(),l=sn[c];return l&&e.setHeader("Content-Type",l),e.statusCode=200,n==="HEAD"?(e.end(),!0):(xt(i).pipe(e),!0)},V=(t,e)=>{t.statusCode=200,t.setHeader("Content-Type","application/json"),t.end(JSON.stringify(e))},un=t=>{const e=(t.method||"GET").toUpperCase();return e==="GET"||e==="HEAD"?Promise.resolve(Buffer.alloc(0)):new Promise((n,r)=>{const s=[];t.on("data",a=>s.push(Buffer.isBuffer(a)?a:Buffer.from(a))),t.on("end",()=>n(Buffer.concat(s))),t.on("error",r)})},L=async(t,e,n,r)=>{const s=new URL(t.url||"/","http://proxy"),a=r??s.pathname.replace(/^\/api/,""),o=new URL(a,n);o.search=s.search;const i=await un(t),c={};for(const[d,f]of Object.entries(t.headers))f&&(c[d]=Array.isArray(f)?f.join(", "):String(f));const l=await fetch(o,{method:t.method||"GET",headers:c,body:i.length?i:void 0});e.statusCode=l.status,l.headers.forEach((d,f)=>{f.toLowerCase()!=="transfer-encoding"&&e.setHeader(f,d)});const u=Buffer.from(await l.arrayBuffer());e.end(u)},Z=async(t,e)=>{const n=new AbortController,r=setTimeout(()=>n.abort(),cn);try{const s=await fetch(t,{signal:n.signal});return s.ok?await s.json():e}catch{return e}finally{clearTimeout(r)}},q=t=>{if(Array.isArray(t))return t;if(t&&typeof t=="object"){const e=t.events;if(Array.isArray(e))return e}return[]},dn=(t,e)=>{const n=Date.now()/1e3,r=Number.isFinite(e)&&e>0?e:60,s=t.filter(p=>typeof p.ts=="number"&&p.ts>=n-r),a=s.length,o=s.filter(p=>p.level==="error"||p.kind==="error").length,i=new Set(s.map(p=>p.actor).filter(p=>typeof p=="string"&&p.length>0)),c=new Set(s.map(p=>p.topic).filter(p=>typeof p=="string"&&p.length>0)),l=s.reduce((p,w)=>typeof w.ts=="number"&&w.ts<p?w.ts:p,n),u=Math.max(n-l,1),d=a>0?a/u*60:0,f=Math.max(a,1),m=s.filter(p=>typeof p.topic=="string"&&p.topic.startsWith("dialogos.")).length;return{now:n,window:r,total:a,errors:o,velocity:d,actorsCount:i.size,topicsCount:c.size,topicEntropy:c.size/f,actorEntropy:i.size/f,dialogosCount:m}},pn=(t,e)=>{const n=dn(t,e);return{snapshot_id:`kroma-${Math.round(n.now*1e3)}`,ts:n.now,iso:new Date().toISOString(),window_seconds:n.window,kpis:{total_events:n.total,total_errors:n.errors,velocity:n.velocity,error_rate:n.total?n.errors/n.total:0,latency:{avg_ms:0,p50_ms:0,p95_ms:0,p99_ms:0}},agents:{count:n.actorsCount,active:n.actorsCount,silent:0,details:{}},topics:{count:n.topicsCount,details:{}},topology:{single_count:0,star_count:0,peer_debate_count:0,avg_fanout:0,coordination_budget_total:0},evolutionary:{vgt_transfers:0,hgt_transfers:0,total_generations:0,avg_speciation_potential:0,lineage_health_distribution:{}},entropy:{topic_entropy:n.topicEntropy,actor_entropy:n.actorEntropy,level_entropy:0,causal_depth_avg:0,reversibility_avg:0},queue:{depth:0,pending:0,completed:n.dialogosCount}}},hn=t=>{const e=t.filter(a=>typeof a.topic=="string"&&a.topic.startsWith("dialogos.")),n=e.reduce((a,o)=>typeof o.ts=="number"&&o.ts>a?o.ts:a,0),r=Date.now()/1e3,s=n>0?Math.max(r-n,1):0;return{status:e.length>0?"ok":"degraded",records_indexed_total:e.length,uptime_seconds:s,records_indexed_per_minute:s>0?e.length/(s/60):0}},mn=(t,e)=>{if(!t.url)return!1;const n=new URL(t.url,"http://api");if(n.pathname==="/api/emit"&&(t.method||"GET").toUpperCase()==="POST")return L(t,e,P,"/publish"),!0;if(n.pathname==="/api/portal/assets"&&(t.method||"GET").toUpperCase()==="POST")return L(t,e,P,"/portal/assets"),!0;if(n.pathname.startsWith("/api/browser/"))return L(t,e,on),!0;if(n.pathname==="/api/session"||n.pathname==="/api/agents"||n.pathname==="/api/io-buffer")return L(t,e,P),!0;if(n.pathname==="/api/bus/events"){const r=Number.parseInt(n.searchParams.get("limit")||"100",10),s=new URL("/events",P);return s.searchParams.set("limit",Number.isFinite(r)?String(r):"100"),Z(s.toString(),{events:[]}).then(a=>V(e,q(a))),!0}if(n.pathname==="/api/metrics/snapshot"){const r=Number.parseInt(n.searchParams.get("window")||"60",10),s=new URL("/events",P);return s.searchParams.set("limit","2000"),Z(s.toString(),{events:[]}).then(a=>V(e,pn(q(a),r))),!0}if(n.pathname==="/api/dialogos/health"){const r=new URL("/events",P);return r.searchParams.set("limit","2000"),Z(r.toString(),{events:[]}).then(s=>V(e,hn(q(s)))),!0}return!1},gn=!!process.argv[1]&&$(process.argv[1])===$(et(import.meta.url));if(gn){const t=Number.parseInt(process.env.PORT||"3000",10),e=process.env.HOST||"0.0.0.0";Bt((n,r)=>{fn(n,r)||mn(n,r)||Tt.router(n,r,()=>Tt.notFound(n,r))}).listen(t,e,()=>{console.log(`[qwik] server ready on http://${e}:${t}`)})}export{Tt as default};
//# sourceMappingURL=entry.node-server.js.map
