#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck disable=SC1091
source "$script_dir/agent_wrapper_common.sh"

orig_home="${HOME:-}"
bus_dir="${PLURIBUS_BUS_DIR:-/pluribus/.pluribus/bus}"
bus_dir="$(plu_resolve_bus_dir "$bus_dir")"
topic_prefix="${PLURIBUS_TOPIC_PREFIX:-agent.gemini}"
export PLURIBUS_ACTOR="gemini"
export PLURIBUS_TASKS_FROM_BUS_RUN=1

plu_emit_nexus_ack "gemini" "$bus_dir"

node20_home="${orig_home:-$HOME}"
if [[ -n "$node20_home" ]] && [[ -d "$node20_home/.local/node20/bin" ]]; then
  export PATH="$node20_home/.local/node20/bin:$PATH"
fi

agent_home="$(plu_prepare_agent_home "gemini" "PLURIBUS_GEMINI_HOME")"
plu_set_xdg "$agent_home"
plu_load_secrets "$orig_home" "$agent_home"
plu_load_assimilation_prompt "gemini"
plu_emit_session_bootstrap "$bus_dir"

prompt_args=()
gemini_cmd="$(command -v gemini || echo gemini)"
if [[ -n "${PLURIBUS_ASSIMILATION_PROMPT:-}" ]]; then
  if prompt_flag="$(plu_detect_prompt_flag "$gemini_cmd")"; then
    prompt_args+=("$prompt_flag" "$PLURIBUS_ASSIMILATION_PROMPT")
  fi
fi

exec "$script_dir/bus-run" --bus-dir "$bus_dir" --topic-prefix "$topic_prefix" -- gemini "${prompt_args[@]}" "$@"
