#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck disable=SC1091
. "${SCRIPT_DIR}/agent_wrapper_common.sh" "gemini"

# Enforce OAuth-only Gemini CLI by stripping API-key env overrides.
unset GEMINI_API_KEY
unset GOOGLE_API_KEY

# Ensure Gemini CLI has ample JS heap to avoid OOM crashes.
GEMINI_MAX_OLD_SPACE_MB="${PLURIBUS_GEMINI_MAX_OLD_SPACE_MB:-6288}"
if [[ "${NODE_OPTIONS:-}" =~ --max-old-space-size=([0-9]+) ]]; then
  current="${BASH_REMATCH[1]}"
  if [[ "$current" =~ ^[0-9]+$ ]] && (( current < GEMINI_MAX_OLD_SPACE_MB )); then
    NODE_OPTIONS="${NODE_OPTIONS/--max-old-space-size=$current/--max-old-space-size=$GEMINI_MAX_OLD_SPACE_MB}"
  fi
else
  if [[ -n "${NODE_OPTIONS:-}" ]]; then
    NODE_OPTIONS="${NODE_OPTIONS} --max-old-space-size=${GEMINI_MAX_OLD_SPACE_MB}"
  else
    NODE_OPTIONS="--max-old-space-size=${GEMINI_MAX_OLD_SPACE_MB}"
  fi
fi
export NODE_OPTIONS="$(echo "${NODE_OPTIONS:-}" | xargs)"

if [ -x /root/.local/node20/bin/gemini ]; then
  exec /root/.local/node20/bin/gemini "$@"
fi

if [ -x /usr/bin/gemini ]; then
  exec /usr/bin/gemini "$@"
fi

echo "gemini CLI not found at /root/.local/node20/bin/gemini or /usr/bin/gemini" >&2
exit 127
